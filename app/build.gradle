plugins {
    id 'java'
    id 'application'
    id 'org.openjfx.javafxplugin' version '0.1.0'
}

repositories {
    mavenCentral()
}

java {
    toolchain {
        languageVersion = JavaLanguageVersion.of(21)
    }
}

javafx {
    version = '21'
    modules = ['javafx.controls', 'javafx.fxml']
    configuration = 'implementation'
}

dependencies {
    testImplementation 'org.junit.jupiter:junit-jupiter:5.10.2'
    
    // JavaFX dependencies
    implementation 'org.openjfx:javafx-controls:21'
    implementation 'org.openjfx:javafx-fxml:21'
    
    // RichTextFX for syntax highlighting and rich text editing
    implementation 'org.fxmisc.richtext:richtextfx:0.11.2'
}

test {
    useJUnitPlatform()
    maxHeapSize = '2048m'
    jvmArgs '-XX:MaxMetaspaceSize=512m'
}

application {
    mainClass = 'com.bisayapp.Bisaya'
}

// Enable standard input for interactive programs
run {
    standardInput = System.in
}

// Copy samples to resources so they're included in the JAR
processResources {
    from('samples') {
        into 'samples'
    }
}

// Task to run the GUI IDE
task runIDE(type: JavaExec) {
    group = 'application'
    description = 'Run the Bisaya++ IDE (GUI)'
    mainClass = 'com.bisayapp.ui.BisayaIDE'
    classpath = sourceSets.main.runtimeClasspath
    
    // Manually set JavaFX module arguments
    jvmArgs = [
        '--module-path', classpath.asPath,
        '--add-modules', 'javafx.controls,javafx.fxml'
    ]
}

tasks.withType(JavaCompile).configureEach {
    options.encoding = 'UTF-8'
}

// Create executable JAR for the IDE
task ideJar(type: Jar) {
    group = 'build'
    description = 'Create executable JAR for Bisaya++ IDE'
    archiveBaseName = 'bisaya-ide'
    archiveVersion = '1.0'
    
    manifest {
        attributes(
            'Main-Class': 'com.bisayapp.ui.BisayaIDE',
            'Implementation-Title': 'Bisaya++ IDE',
            'Implementation-Version': '1.0'
        )
    }
    
    from {
        configurations.runtimeClasspath.collect { it.isDirectory() ? it : zipTree(it) }
    }
    
    with jar
    
    duplicatesStrategy = DuplicatesStrategy.EXCLUDE
}

// Create executable JAR for CLI
task cliJar(type: Jar) {
    group = 'build'
    description = 'Create executable JAR for Bisaya++ CLI'
    archiveBaseName = 'bisaya-cli'
    archiveVersion = '1.0'
    
    manifest {
        attributes(
            'Main-Class': 'com.bisayapp.Bisaya',
            'Implementation-Title': 'Bisaya++ Interpreter',
            'Implementation-Version': '1.0'
        )
    }
    
    from {
        configurations.runtimeClasspath.collect { it.isDirectory() ? it : zipTree(it) }
    }
    
    with jar
    
    duplicatesStrategy = DuplicatesStrategy.EXCLUDE
}

// ============================================================================
// Manual jpackage task for creating Windows MSI installer with WiX
// ============================================================================

task prepareJPackageInput {
    group = 'distribution'
    description = 'Prepare input directory for jpackage using fat JAR'
    dependsOn ideJar
    
    doLast {
        // Clean and create directory
        delete "${buildDir}/jpackage-input"
        mkdir "${buildDir}/jpackage-input"
        
        // Copy the fat JAR (includes all dependencies)
        copy {
            from("${buildDir}/libs") {
                include 'bisaya-ide-1.0.jar'
            }
            into "${buildDir}/jpackage-input"
        }
        
        println "✓ Copied fat JAR with all dependencies"
    }
}

task createMSI(type: Exec) {
    group = 'distribution'
    description = 'Create Windows MSI installer using jpackage with JavaFX jmods'
    dependsOn prepareJPackageInput
    
    workingDir projectDir
    
    // Ensure WiX is in PATH
    environment 'PATH', System.getenv('PATH') + ";C:\\Program Files (x86)\\WiX Toolset v3.11\\bin"
    
    // Path to JavaFX jmods
    def javafxModsPath = 'C:\\javafx-jmods-21.0.9'
    
    commandLine 'jpackage',
        '--type', 'msi',
        '--input', "${buildDir}/jpackage-input",
        '--name', 'BisayaIDE',
        '--main-jar', 'bisaya-ide-1.0.jar',
        '--main-class', 'com.bisayapp.ui.BisayaIDE',
        '--app-version', '1.0.0',
        '--vendor', 'Bisaya++ Project',
        '--description', 'Bisaya++ Programming Language IDE',
        '--win-dir-chooser',
        '--win-menu',
        '--win-shortcut',
        '--dest', "${buildDir}/distribution",
        '--module-path', javafxModsPath,
        '--add-modules', 'javafx.controls,javafx.fxml'
    
    doFirst {
        delete "${buildDir}/distribution"
        mkdir "${buildDir}/distribution"
        
        // Verify JavaFX jmods exist
        if (!file(javafxModsPath).exists()) {
            throw new GradleException("JavaFX jmods not found at: ${javafxModsPath}")
        }
        
        def jmodFiles = file(javafxModsPath).listFiles({ it.name.endsWith('.jmod') } as FileFilter)
        println "Creating MSI installer with JavaFX jmods..."
        println "JavaFX jmods path: ${javafxModsPath}"
        println "Found ${jmodFiles?.length ?: 0} jmod files"
        println "Output will be in: ${buildDir}/distribution"
    }
    
    doLast {
        println "✅ MSI installer created successfully!"
        println "✅ JavaFX modules included in bundled JRE"
        println "Location: ${buildDir}/distribution/BisayaIDE-1.0.0.msi"
    }
}
